<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1368px" preserveAspectRatio="none" style="width:1242px;height:1368px;background:#FFFFFF;" version="1.1" viewBox="0 0 1242 1368" width="1242px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="26.2969" id="_title" style="stroke:none;stroke-width:1.0;" width="303" x="470.75" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="293" x="475.75" y="27.9951">Authorization token with auth_code</text><rect fill="#DDDDDD" height="1312.4297" style="stroke:#181818;stroke-width:0.5;" width="786.5" x="380" y="43.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="76" x="735.25" y="55.3638">K8S_ZONE</text><rect fill="#FFFFFF" height="1064.3047" style="stroke:#181818;stroke-width:1.0;" width="10" x="227" y="134.7266"/><rect fill="#FFFFFF" height="1009.9063" style="stroke:#181818;stroke-width:1.0;" width="10" x="530" y="189.125"/><rect fill="#FFFFFF" height="834.2773" style="stroke:#181818;stroke-width:1.0;" width="10" x="860.5" y="364.7539"/><rect fill="#FFFFFF" height="77.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="1121.5" y="507.1172"/><rect fill="#FFFFFF" height="104.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="1121.5" y="987.8359"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="232" x2="232" y1="124.7266" y2="1290.4297"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="535" x2="535" y1="124.7266" y2="1290.4297"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="865" x2="865" y1="124.7266" y2="1290.4297"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1126.5" x2="1126.5" y1="124.7266" y2="1290.4297"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="44" x="210" y="93.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="217" y="113.4248">web</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="44" x="210" y="1289.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="217" y="1309.4248">web</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="484" y="93.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="491" y="113.4248">bff_web_api</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="484" y="1289.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="491" y="1309.4248">bff_web_api</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="796" y="93.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="803" y="113.4248">authorization_api</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="139" x="796" y="1289.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125" x="803" y="1309.4248">authorization_api</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="1090.5" y="121.4248">k8s_redis</text><path d="M1108.5,72.4297 C1108.5,62.4297 1126.5,62.4297 1126.5,62.4297 C1126.5,62.4297 1144.5,62.4297 1144.5,72.4297 L1144.5,98.4297 C1144.5,108.4297 1126.5,108.4297 1126.5,108.4297 C1126.5,108.4297 1108.5,108.4297 1108.5,98.4297 L1108.5,72.4297 " fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M1108.5,72.4297 C1108.5,82.4297 1126.5,82.4297 1126.5,82.4297 C1126.5,82.4297 1144.5,82.4297 1144.5,72.4297 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="1090.5" y="1302.4248">k8s_redis</text><path d="M1108.5,1315.7266 C1108.5,1305.7266 1126.5,1305.7266 1126.5,1305.7266 C1126.5,1305.7266 1144.5,1305.7266 1144.5,1315.7266 L1144.5,1341.7266 C1144.5,1351.7266 1126.5,1351.7266 1126.5,1351.7266 C1126.5,1351.7266 1108.5,1351.7266 1108.5,1341.7266 L1108.5,1315.7266 " fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M1108.5,1315.7266 C1108.5,1325.7266 1126.5,1325.7266 1126.5,1325.7266 C1126.5,1325.7266 1144.5,1325.7266 1144.5,1315.7266 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><rect fill="#FFFFFF" height="1064.3047" style="stroke:#181818;stroke-width:1.0;" width="10" x="227" y="134.7266"/><rect fill="#FFFFFF" height="1009.9063" style="stroke:#181818;stroke-width:1.0;" width="10" x="530" y="189.125"/><rect fill="#FFFFFF" height="834.2773" style="stroke:#181818;stroke-width:1.0;" width="10" x="860.5" y="364.7539"/><rect fill="#FFFFFF" height="77.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="1121.5" y="507.1172"/><rect fill="#FFFFFF" height="104.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="1121.5" y="987.8359"/><polygon fill="#181818" points="518,185.125,528,189.125,518,193.125,522,189.125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="237" x2="524" y1="189.125" y2="189.125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="244" y="184.0591">/api/v1/auth/token</text><path d="M5,139.7266 L5,224.7266 L222,224.7266 L222,149.7266 L212,139.7266 L5,139.7266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M212,139.7266 L212,149.7266 L222,149.7266 L212,139.7266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="11" y="156.7935">Reuqest header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="11" y="171.9263">Content-Type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="11" y="187.0591"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="11" y="202.1919">Request body</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="11" y="217.3247">- auth_code: xxxxxx</text><line style="stroke:#181818;stroke-width:1.0;" x1="540" x2="582" y1="251.5234" y2="251.5234"/><line style="stroke:#181818;stroke-width:1.0;" x1="582" x2="582" y1="251.5234" y2="264.5234"/><line style="stroke:#181818;stroke-width:1.0;" x1="541" x2="582" y1="264.5234" y2="264.5234"/><polygon fill="#181818" points="551,260.5234,541,264.5234,551,268.5234,547,264.5234" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="547" y="246.4575">validate request</text><polygon fill="#181818" points="848.5,360.7539,858.5,364.7539,848.5,368.7539,852.5,364.7539" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="540" x2="854.5" y1="364.7539" y2="364.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="547" y="359.688">/api/v1/oauth/token</text><path d="M176,277.5234 L176,438.5234 L525,438.5234 L525,287.5234 L515,277.5234 L176,277.5234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M515,277.5234 L515,287.5234 L525,287.5234 L515,277.5234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="182" y="294.5903"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="182" y="309.7231">Request header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328" x="182" y="324.856">Content-Type: application/x-www-form-urlencoded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="182" y="339.9888"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="182" y="355.1216">Request body</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="182" y="370.2544">- auth_code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="182" y="385.3872"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="182" y="400.52">note:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="182" y="415.6528">- handler late limit (brute force attack)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="182" y="430.7856"> </text><line style="stroke:#181818;stroke-width:1.0;" x1="870.5" x2="912.5" y1="464.9844" y2="464.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="912.5" x2="912.5" y1="464.9844" y2="477.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="871.5" x2="912.5" y1="477.9844" y2="477.9844"/><polygon fill="#181818" points="881.5,473.9844,871.5,477.9844,881.5,481.9844,877.5,477.9844" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="877.5" y="459.9185">validate request</text><polygon fill="#181818" points="1109.5,503.1172,1119.5,507.1172,1109.5,511.1172,1113.5,507.1172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="870.5" x2="1115.5" y1="507.1172" y2="507.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="207" x="877.5" y="502.0513">check auth_code from k8s_redis</text><polygon fill="#181818" points="881.5,580.6484,871.5,584.6484,881.5,588.6484,877.5,584.6484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="875.5" x2="1125.5" y1="584.6484" y2="584.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="887.5" y="579.5825">return redis object</text><path d="M1136,520.1172 L1136,635.1172 L1235,635.1172 L1235,530.1172 L1225,520.1172 L1136,520.1172 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1225,520.1172 L1225,530.1172 L1235,530.1172 L1225,520.1172 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1142" y="537.1841"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="29" x="1142" y="552.3169">Key:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1142" y="567.4497">- auth_code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1142" y="582.5825"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="1142" y="597.7153">Redis object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="1142" y="612.8481">- user_id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="1142" y="627.981">- scope</text><line style="stroke:#181818;stroke-width:1.0;" x1="870.5" x2="912.5" y1="779.7422" y2="779.7422"/><line style="stroke:#181818;stroke-width:1.0;" x1="912.5" x2="912.5" y1="779.7422" y2="792.7422"/><line style="stroke:#181818;stroke-width:1.0;" x1="871.5" x2="912.5" y1="792.7422" y2="792.7422"/><polygon fill="#181818" points="881.5,788.7422,871.5,792.7422,881.5,796.7422,877.5,792.7422" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="237" x="877.5" y="774.6763">generate JWT Token with private key</text><path d="M737,646.0469 L737,913.0469 L855,913.0469 L855,656.0469 L845,646.0469 L737,646.0469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M845,646.0469 L845,656.0469 L855,656.0469 L845,646.0469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="90" x="743" y="663.1138">Access token:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="743" y="678.2466">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="45" x="759" y="693.3794">header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81" x="759" y="708.5122">- alg: rsa256</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="759" y="723.645">- typ: JWT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="743" y="738.7778"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="759" y="753.9106">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="26" x="759" y="769.0435">- iss</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="20" x="759" y="784.1763">- jti</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="759" y="799.3091">- user_id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="25" x="759" y="814.4419">- iat</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="33" x="759" y="829.5747">- exp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="40" x="759" y="844.7075">- roles</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="743" y="859.8403"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60" x="759" y="874.9731">signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="9" x="743" y="890.106">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="743" y="905.2388"> </text><polygon fill="#181818" points="1109.5,983.8359,1119.5,987.8359,1109.5,991.8359,1113.5,987.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="870.5" x2="1115.5" y1="987.8359" y2="987.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197" x="877.5" y="982.77">put user session into k8s_redis</text><path d="M632,923.3047 L632,1038.3047 L855,1038.3047 L855,933.3047 L845,923.3047 L632,923.3047 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M845,923.3047 L845,933.3047 L855,933.3047 L845,923.3047 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="638" y="940.3716">ttl: 300000 milliseconds (5 min)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="638" y="955.5044"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="638" y="970.6372">Key: user_id:xxxxx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="638" y="985.77"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="638" y="1000.9028">Redis object value:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="638" y="1016.0356">- access_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="638" y="1031.1685">- refrech_token</text><line style="stroke:#181818;stroke-width:1.0;" x1="1131.5" x2="1173.5" y1="1065.3672" y2="1065.3672"/><line style="stroke:#181818;stroke-width:1.0;" x1="1173.5" x2="1173.5" y1="1065.3672" y2="1078.3672"/><line style="stroke:#181818;stroke-width:1.0;" x1="1132.5" x2="1173.5" y1="1078.3672" y2="1078.3672"/><polygon fill="#181818" points="1142.5,1074.3672,1132.5,1078.3672,1142.5,1082.3672,1138.5,1078.3672" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="1138.5" y="1060.3013">save data</text><polygon fill="#181818" points="881.5,1088.3672,871.5,1092.3672,881.5,1096.3672,877.5,1092.3672" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="875.5" x2="1125.5" y1="1092.3672" y2="1092.3672"/><polygon fill="#181818" points="551,1117.5,541,1121.5,551,1125.5,547,1121.5" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="545" x2="859.5" y1="1121.5" y2="1121.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="39" x="557" y="1116.4341">return</text><polygon fill="#181818" points="243,1195.0313,233,1199.0313,243,1203.0313,239,1199.0313" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="237" x2="534" y1="1199.0313" y2="1199.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="39" x="249" y="1193.9653">return</text><path d="M545,1134.5 L545,1249.5 L762,1249.5 L762,1144.5 L752,1134.5 L545,1134.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M752,1134.5 L752,1144.5 L762,1144.5 L752,1134.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112" x="551" y="1151.5669">Response header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="551" y="1166.6997">Content-Type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="551" y="1181.8325"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="551" y="1196.9653">Response body</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="551" y="1212.0981">- accessToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="551" y="1227.231">- RefreshToken</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="551" y="1242.3638"> </text><!--MD5=[6e5a5266f39ad8fe6a6a829e33408e8d]
@startuml
title Authorization token with auth_code
' autonumber
skinparam ParticipantPadding 100
skinparam BoxPadding 20

participant web
box NHSO

end box

box K8S_ZONE
participant bff_web_api
participant authorization_api
database k8s_redis
end box

activate web
web -> bff_web_api : /api/v1/auth/token

' activate authorization_api
note left
    Reuqest header
    Content-Type: application/json

    Request body
    - auth_code: xxxxxx
end note
activate bff_web_api

bff_web_api -> bff_web_api : validate request
bff_web_api -> authorization_api : /api/v1/oauth/token
activate authorization_api
note left
    
    Request header
    Content-Type: application/x-www-form-urlencoded

    Request body
    - auth_code

    note: 
    - handler late limit (brute force attack)

end note
authorization_api -> authorization_api : validate request
authorization_api -> k8s_redis : check auth_code from k8s_redis
activate k8s_redis
k8s_redis - -> authorization_api: return redis object
note right

    Key:
    - auth_code

    Redis object
    - user_id
    - scope
end note
deactivate k8s_redis
authorization_api -> authorization_api : generate JWT Token with private key
note left
    Access token:
    {
        header
        - alg: rsa256
        - typ: JWT

        payload
        - iss
        - jti
        - user_id
        - iat
        - exp
        - roles

        signature
    }

end note
authorization_api -> k8s_redis : put user session into k8s_redis
activate k8s_redis
note left
    ttl: 300000 milliseconds (5 min)

    Key: user_id:xxxxx

    Redis object value:
    - access_token
    - refrech_token
end note
k8s_redis -> k8s_redis: save data
k8s_redis - -> authorization_api
deactivate k8s_redis
' alt#Gold #LightBlue success
authorization_api - -> bff_web_api : return

bff_web_api - -> web : return
note right
    Response header
    Content-Type: application/json

    Response body
    - accessToken
    - RefreshToken

end note
deactivate authorization_api
|||
deactivate bff_web_api
deactivate web
@enduml

@startuml
title Authorization token with auth_code
skinparam ParticipantPadding 100
skinparam BoxPadding 20

participant web
box NHSO

end box

box K8S_ZONE
participant bff_web_api
participant authorization_api
database k8s_redis
end box

activate web
web -> bff_web_api : /api/v1/auth/token

note left
    Reuqest header
    Content-Type: application/json

    Request body
    - auth_code: xxxxxx
end note
activate bff_web_api

bff_web_api -> bff_web_api : validate request
bff_web_api -> authorization_api : /api/v1/oauth/token
activate authorization_api
note left
    
    Request header
    Content-Type: application/x-www-form-urlencoded

    Request body
    - auth_code

    note: 
    - handler late limit (brute force attack)

end note
authorization_api -> authorization_api : validate request
authorization_api -> k8s_redis : check auth_code from k8s_redis
activate k8s_redis
k8s_redis - -> authorization_api: return redis object
note right

    Key:
    - auth_code

    Redis object
    - user_id
    - scope
end note
deactivate k8s_redis
authorization_api -> authorization_api : generate JWT Token with private key
note left
    Access token:
    {
        header
        - alg: rsa256
        - typ: JWT

        payload
        - iss
        - jti
        - user_id
        - iat
        - exp
        - roles

        signature
    }

end note
authorization_api -> k8s_redis : put user session into k8s_redis
activate k8s_redis
note left
    ttl: 300000 milliseconds (5 min)

    Key: user_id:xxxxx

    Redis object value:
    - access_token
    - refrech_token
end note
k8s_redis -> k8s_redis: save data
k8s_redis - -> authorization_api
deactivate k8s_redis
authorization_api - -> bff_web_api : return

bff_web_api - -> web : return
note right
    Response header
    Content-Type: application/json

    Response body
    - accessToken
    - RefreshToken

end note
deactivate authorization_api
|||
deactivate bff_web_api
deactivate web
@enduml

PlantUML version 1.2022.10beta1(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>